# NanoAnalysis: Nanopore Sequencing Analysis Pipeline

A comprehensive Snakemake workflow for analyzing Oxford Nanopore sequencing data, including read filtering, alignment, variant calling, and consensus sequence generation.

## Features

- **Quality Control**: Filter and trim nanopore reads with NanoFilt
- **Alignment**: Map reads to reference genomes using Minimap2 with ONT-specific parameters
- **Variant Calling**: Call and filter variants using Samtools and BCFtools
- **Coverage Analysis**: Generate coverage plots with BEDTools and R
- **Consensus Generation**: Build sample-specific consensus sequences
- **Multiple Alignment**: Align all consensus sequences with MAFFT
- **Reporting**: Comprehensive QC reporting with MultiQC

## Requirements

- Conda or Miniconda
- Mamba (recommended for faster dependency resolution)
- Git

## Quick Start

```bash
# Clone the repository
git clone https://github.com/yourusername/nano_analysis.git
cd nano_analysis

# Create and activate the main environment
mamba env create -f environment.yaml
conda activate nano_analysis

# Configure your project
cp config_template.yaml projects/my_project/config.yaml
# Edit the config.yaml file with your specific parameters

# Run the pipeline
snakemake --configfile projects/my_project/config.yaml --use-conda --cores 16
```

## Directory Structure

```
nano_analysis/
├── Snakefile              # Main workflow definition
├── environment.yaml       # Main environment definition
├── config_template.yaml   # Template for project configuration
├── envs/                  # Conda environment definitions
├── scripts/               # Support scripts for the workflow
├── projects/              # Project-specific directories
│   ├── project1/          # Example project
│   │   ├── config.yaml    # Project-specific configuration
│   │   ├── data/          # Project data (or symlinks)
│   │   │   ├── barcode01/
│   │   │   ├── barcode02/
│   │   │   └── ...
│   │   ├── reference/     # Project reference genome(s)
│   │   └── results/       # Project results (generated by the pipeline)
│   └── project2/
│       └── ...
└── README.md              # This documentation file
```

## Setting Up a New Project

1. **Create a project directory**:
   ```bash
   mkdir -p projects/my_project/{data,reference,results}
   ```

2. **Create a project configuration file**:
   ```bash
   cp config_template.yaml projects/my_project/config.yaml
   ```

3. **Edit the configuration file** to set project-specific parameters:
   ```yaml
   # Project information
   project_name: "my_project"
   
   # Input/Output paths
   input_dir: "projects/my_project/data"
   reference_genome: "projects/my_project/reference/reference.fasta"
   results_dir: "projects/my_project/results"
   
   # Analysis parameters
   min_read_quality: 8
   min_read_length: 500
   headcrop: 50
   variant_depth: 30
   variant_quality: 60
   ```

4. **Add your reference genome**:
   ```bash
   cp /path/to/your/reference.fasta projects/my_project/reference/
   ```

5. **Prepare your data**:
   ```bash
   # Option 1: Create symbolic links to your data
   ln -s /path/to/nanopore/output/barcode* projects/my_project/data/
   
   # Option 2: Copy your data
   cp -r /path/to/nanopore/output/barcode* projects/my_project/data/
   ```

6. **Run the pipeline**:
   ```bash
   snakemake --configfile projects/my_project/config.yaml --use-conda --cores 16
   ```

## Advanced Usage

### Running Multiple Projects

You can maintain multiple projects within the same pipeline installation:

```bash
# Create project-specific configurations
cp config_template.yaml projects/project1/config.yaml
cp config_template.yaml projects/project2/config.yaml

# Run specific projects
snakemake --configfile projects/project1/config.yaml --use-conda --cores 16
snakemake --configfile projects/project2/config.yaml --use-conda --cores 16
```

### Pipeline Parameters

Edit your project's `config.yaml` file to customize parameters:

| Parameter | Description | Default |
|-----------|-------------|---------|
| `min_read_quality` | Minimum quality score for reads | 8 |
| `min_read_length` | Minimum read length | 500 |
| `headcrop` | Number of bases to trim from start | 50 |
| `variant_depth` | Minimum depth for variants | 30 |
| `variant_quality` | Minimum quality for variants | 60 |
| `threads` | Threads for parallel processes | 16 |

### Troubleshooting

- **Missing files error**: Increase latency wait time with `--latency-wait 60`
- **Lock error**: Use `snakemake --unlock` to remove stale locks
- **Conda environment issues**: Try using Mamba for faster and more reliable environment creation

## Output Files

Results are organized into the following directories:

- `results/filtered_fastq/`: Quality filtered reads
- `results/fastqc/`: QC reports for reads
- `results/alignments/`: BAM files from alignments
- `results/variants/`: Variant calls (VCF format)
- `results/bedgraph/`: Coverage files
- `results/coverage_plots/`: Coverage visualizations
- `results/consensus/`: Consensus sequences per sample
- `results/mafft_alignment/`: Multiple sequence alignment
- `results/multiqc/`: MultiQC summary report

## Citation

If you use this pipeline in your research, please cite:

```
[Your Name]. (2025). NanoAnalysis: A Snakemake Workflow for Oxford Nanopore Sequencing Data Analysis. GitHub. https://github.com/yourusername/nano_analysis
```

## License

This project is licensed under the MIT License - see the LICENSE file for details.
